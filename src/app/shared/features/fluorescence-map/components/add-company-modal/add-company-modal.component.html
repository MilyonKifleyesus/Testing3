@if (isVisible()) {
<div class="modal-overlay" (click)="onBackdropClick($event)" role="dialog" aria-modal="true"
  aria-labelledby="modal-title">
  <div class="modal-container" (click)="stopPropagation($event)" [attr.aria-busy]="isSubmitting()">
    <!-- Modal Header -->
    <div class="modal-header">
      <div class="modal-title-section">
        <h1 class="modal-title" id="modal-title">Add Project</h1>
        <p class="modal-subtitle">Adding a project creates a connection line on the map between the client and factory.</p>
      </div>
      <div class="modal-header-actions">
        <button type="button" class="btn-load-sample" (click)="loadSampleData()" [disabled]="isSubmitting()">
          Load Sample
        </button>
        <button class="modal-close-btn" type="button" (click)="onClose()" aria-label="Close modal"
          [disabled]="isSubmitting()">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      @if (submissionState() === 'SUCCESS') {
      <div class="success-view">
        <div class="success-icon-container">
          <span class="material-symbols-outlined success-icon">check_circle</span>
        </div>
        <h2 class="success-title">Project Registered</h2>
        <p class="success-description">
          {{ successMessage() || (projectName() + ' has been added. A new connection line will appear on the map.') }}
        </p>
        <div class="success-details">
          <div class="detail-row">
            <span class="detail-label">Client:</span>
            <span class="detail-value">{{ clientId() }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Status:</span>
            <span class="detail-value" [class]="getProjectStatusClass(projectStatus())">{{ projectStatus() }}</span>
          </div>
        </div>
      </div>
      } @else {
      <!-- Error Message -->
      @if (errorMessage()) {
      <div class="error-message">
        <span class="material-symbols-outlined me-2 fs-18">warning</span>
        {{ errorMessage() }}
      </div>
      }

      <!-- Step Indicator -->
      <div class="step-indicator">
        @for (s of [1,2,3,4]; track s) {
        <button type="button" class="step-dot" [class.active]="currentStep() === s" [class.completed]="currentStep() > s"
          (click)="goToStep(s)" [disabled]="isSubmitting()" [attr.aria-current]="currentStep() === s ? 'step' : null">
          {{ s }}
        </button>
        @if (s < 4) {
        <span class="step-connector"></span>
        }
        }
      </div>

      <!-- Step 1: Select Client -->
      @if (currentStep() === 1) {
      <div class="connection-section" [class.disabled]="isSubmitting()">
        <div class="section-header">
          <span class="section-title">Select Client</span>
        </div>
        <p class="section-helper">
          Choose the client this project will be associated with. The project will create a connection line from this client to the selected factory on the map.
        </p>
        <div class="form-field">
          <label class="form-label" for="client-select">Client</label>
          <ng-select id="client-select" class="form-select-ng"
            [items]="clients()"
            bindLabel="name"
            bindValue="id"
            [clearable]="true"
            [searchable]="true"
            placeholder="Search for a client..."
            [disabled]="isSubmitting()"
            (ngModelChange)="clientId.set($event)"
            [ngModel]="clientId()">
          </ng-select>
        </div>
      </div>
      }

      <!-- Step 2: Select Factory -->
      @if (currentStep() === 2) {
      <div class="connection-section" [class.disabled]="isSubmitting()">
        <div class="section-header">
          <span class="section-title">Select Factory</span>
        </div>
        <p class="section-helper">
          Choose the manufacturer factory location for this project.
        </p>
        <div class="form-field">
          <label class="form-label" for="factory-select">Factory</label>
          <ng-select id="factory-select" class="form-select-ng"
            [items]="factoryOptions()"
            bindLabel="label"
            [clearable]="true"
            [searchable]="true"
            placeholder="Search for manufacturer - factory (city, country)..."
            [disabled]="isSubmitting()"
            (ngModelChange)="onFactorySelect($event)"
            [ngModel]="selectedFactory()">
          </ng-select>
        </div>
      </div>
      }

      <!-- Step 3: Project Details -->
      @if (currentStep() === 3) {
      <div class="connection-section" [class.disabled]="isSubmitting()">
        <div class="section-header">
          <span class="section-title">Project Details</span>
        </div>
        <p class="section-helper">
          Enter the project name, assessment type, and status.
        </p>
        <div class="form-field">
          <label class="form-label" for="project-name">Project Name</label>
          <input type="text" id="project-name" class="form-input" placeholder="e.g., Nova - LE96 40FT"
            [value]="projectName()" (input)="projectName.set($any($event.target).value)"
            [disabled]="isSubmitting()" />
        </div>
        <div class="form-field">
          <label class="form-label" for="assessment-type">Assessment Type</label>
          <ng-select id="assessment-type" class="form-select-ng"
            [items]="projectTypes()"
            [clearable]="true"
            [searchable]="true"
            placeholder="Select assessment type..."
            [disabled]="isSubmitting()"
            (ngModelChange)="assessmentType.set($event)"
            [ngModel]="assessmentType()">
          </ng-select>
        </div>
        <div class="form-field">
          <label class="form-label">Project Status</label>
          <label class="sub-location-status-toggle" [title]="'Active projects appear on the map; Inactive do not.'">
            <input type="checkbox" [checked]="projectStatus() === 'Active'"
              (change)="projectStatus.set($any($event.target).checked ? 'Active' : 'Inactive')"
              [disabled]="isSubmitting()" />
            <span class="toggle-track"></span>
            <span class="toggle-label">{{ projectStatus() }}</span>
          </label>
        </div>
      </div>
      }

      <!-- Step 4: Optional Location and Notes -->
      @if (currentStep() === 4) {
      <div class="form-field" [class.disabled]="isSubmitting()">
        <label class="form-label" for="project-location">Location (Optional)</label>
        <input type="text" id="project-location" class="form-input" placeholder="e.g., Winnipeg-Crookston (New Flyer)"
          [value]="location()" (input)="location.set($any($event.target).value)"
          [disabled]="isSubmitting()" />
      </div>
      <div class="form-field" [class.disabled]="isSubmitting()">
        <label class="form-label" for="project-notes">Notes (Optional)</label>
        <textarea id="project-notes" class="form-input form-textarea" placeholder="Additional notes..."
          [value]="notes()" (input)="notes.set($any($event.target).value)"
          [disabled]="isSubmitting()"></textarea>
      </div>
      }

      <!-- Step Navigation -->
      @if (currentStep() < 4) {
      <div class="step-nav">
        @if (currentStep() > 1) {
        <button type="button" class="btn-abort" (click)="prevStep()" [disabled]="isSubmitting()">Back</button>
        }
        <button type="button" class="btn-compact btn-next" (click)="nextStep()"
          [disabled]="(currentStep() === 1 && !canProceedToStep2()) || (currentStep() === 2 && !canProceedToStep3()) || (currentStep() === 3 && !canProceedToStep4()) || isSubmitting()">
          Next
        </button>
      </div>
      }
      }
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      @if (submissionState() === 'SUCCESS') {
      <div class="success-footer-note">Closing in 2 seconds...</div>
      } @else {
      <button type="button" class="btn-abort" (click)="onClose()" [disabled]="isSubmitting()">
        Abort
      </button>
      @if (currentStep() === 4) {
      <button type="button" class="btn-abort" (click)="prevStep()" [disabled]="isSubmitting()">Back</button>
      <button type="button" class="btn-execute" (click)="onSubmit()" [disabled]="!isFormValid() || isSubmitting()">
        @if (isSubmitting()) {
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        Saving...
        } @else {
        Add Project
        }
      </button>
      }
      }
    </div>
  </div>
</div>
}
