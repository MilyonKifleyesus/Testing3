<div class="war-room-map-container" [attr.data-theme-mode]="currentTheme()">
  <!-- Grid Overlay -->
  <div class="grid-overlay"></div>

  <!-- Map Container: overlays inside #war-room-map so (0,0) matches MapLibre project() â€“ stops marker/logo drift on zoom -->
  <div class="map-container" (click)="clearPinned()">
    <div #mapContainer id="war-room-map" class="war-room-map-inner">
      <app-war-room-map-routes [routes]="routesVm()" [routeStroke]="routeStroke()" [routeFill]="routeFill()"
        (routeSelected)="onRouteSelected($event)">
      </app-war-room-map-routes>
      <app-war-room-map-markers [markers]="markersVm()" [pixelCoordinates]="markerPixelCoordinates()"
        (markerClick)="handleMarkerClick($event)" (markerHover)="onMarkerHovered($event)"
        (logoError)="onMarkerLogoError($event)">
      </app-war-room-map-markers>
    </div>

    <app-war-room-map-controls [fullscreen]="fullscreenState()" [zoomLevel]="currentZoomLevel()"
      (zoomChange)="setZoomTo($event)" (zoomIn)="zoomIn()" (zoomOut)="zoomOut()"
      (toggleFullscreen)="toggleFullscreen()"></app-war-room-map-controls>
  </div>

  <app-war-room-map-tooltip [tooltip]="tooltipVm()" (logoError)="onTooltipLogoError($event)">
  </app-war-room-map-tooltip>

  @if (mapLoadError()) {
  <div class="map-error-overlay">
    <p>{{ mapLoadError() }}</p>
    <button type="button" class="btn btn-primary btn-sm" (click)="retryMapLoad()">Retry</button>
  </div>
  }
</div>