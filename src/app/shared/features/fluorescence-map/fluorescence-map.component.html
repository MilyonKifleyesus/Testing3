<div class="war-room-container">
  <div class="visually-hidden" aria-live="polite" aria-atomic="true">{{ announcementMessage() }}</div>
  <!-- TestSprite marker stability assertions - visible for automation -->
  @if (markerStabilityMessage()) {
  <div class="marker-stability-status" data-testid="marker-stability-status" role="status">
    {{ markerStabilityMessage() }}
  </div>
  }
  <!-- Main Content -->
  <main class="war-room-main">
    <!-- Map Area -->
    <div class="war-room-map-area" [class.add-project-mode]="addCompanyModalVisible()"
      [attr.aria-describedby]="addCompanyModalVisible() ? 'add-project-mode-announcement' : null">
      @if (addCompanyModalVisible()) {
      <div id="add-project-mode-announcement" class="visually-hidden" aria-live="polite" aria-atomic="true">
        Add Project mode active.
      </div>
      }
      <!-- Single toolbar: view toggle + active filters in one compact strip (hidden in tactical mode) -->
      @if (!tacticalMode()) {
      <div class="war-room-map-toolbar" role="toolbar" aria-label="Map view and filters">
        <div class="map-view-toggle card custom-card d-flex align-items-center gap-2 p-2">
          <div class="btn-group btn-group-sm" role="radiogroup" aria-label="Map view mode selection">
            <button type="button" class="btn map-view-btn" [class.btn-primary]="mapViewMode() === 'project'"
              [class.btn-outline-primary]="mapViewMode() !== 'project'" (click)="setMapViewMode('project')"
              role="radio" [attr.aria-checked]="mapViewMode() === 'project'" aria-label="Switch to project view">
              Project View
            </button>
            <button type="button" class="btn map-view-btn" [class.btn-primary]="mapViewMode() === 'client'"
              [class.btn-outline-primary]="mapViewMode() !== 'client'" (click)="setMapViewMode('client')"
              role="radio" [attr.aria-checked]="mapViewMode() === 'client'" aria-label="Switch to client view">
              Client View
            </button>
            <button type="button" class="btn map-view-btn" [class.btn-primary]="mapViewMode() === 'factory'"
              [class.btn-outline-primary]="mapViewMode() !== 'factory'" (click)="setMapViewMode('factory')" role="radio"
              [attr.aria-checked]="mapViewMode() === 'factory'" aria-label="Switch to factory view">
              Factory View
            </button>
          </div>
          <button type="button" class="btn btn-primary btn-icon-text btn-sm map-add-project-btn"
            (click)="onAddCompanyRequested()" aria-label="Add new project to map">
            <i class="fe fe-plus-circle me-2 fs-14" aria-hidden="true"></i> Add Project
          </button>
          <button type="button" class="btn btn-white btn-icon-text btn-sm map-filter-btn" (click)="toggleFiltersPanel()"
            [class.btn-primary-transparent]="filtersPanelVisible()"
            [attr.aria-label]="(filtersPanelVisible() ? 'Close' : 'Open') + ' filters' + (activeFilterCount() > 0 ? ' (' + activeFilterCount() + ' active)' : '')"
            [attr.aria-expanded]="filtersPanelVisible()">
            <i class="fe fe-filter me-2 fs-14" aria-hidden="true"></i> Filter
            @if (activeFilterCount() > 0) {
            <span class="badge bg-primary-transparent ms-1" aria-hidden="true">{{ activeFilterCount() }}</span>
            }
          </button>
        </div>
        @if (activeFilters().length > 0) {
        <div class="active-filters-bar d-flex flex-wrap align-items-center gap-2">
          <span class="text-muted fs-12 fw-medium text-uppercase me-1">Active Filters:</span>
          @for (filter of activeFilters(); track filter.value) {
          <span
            class="badge bg-primary-transparent text-primary d-flex align-items-center gap-2 px-3 py-2 rounded-pill border border-primary-transparent">
            {{ filter.label }}
            <button class="btn-unstyled cursor-pointer ms-1 fs-12" (click)="removeFilter(filter)"
              [attr.aria-label]="'Remove ' + filter.label + ' filter'">
              <i class="fe fe-x" aria-hidden="true"></i>
            </button>
          </span>
          }
          <button class="btn btn-link btn-sm text-danger text-uppercase fs-11 fw-bold p-0 ms-2"
            (click)="clearAllFilters()" aria-label="Clear all active filters">
            Clear All
          </button>
        </div>
        }
      </div>
      }

      <div class="map-action-bar" [class.hidden]="tacticalMode()" role="group"
        aria-label="Map panels and layout controls">
        <button type="button" class="map-action-btn" (click)="togglePanels()" [class.active]="panelVisible()"
          [attr.aria-label]="panelVisible() ? 'Hide panels' : 'Show panels'" [attr.aria-expanded]="panelVisible()"
          aria-controls="war-room-overlay-panel">
          <i class="fe fe-layers me-2" aria-hidden="true"></i>
          <span>{{ panelVisible() ? 'Hide Panels' : 'Panels' }}</span>
        </button>
        <button type="button" class="map-action-btn" (click)="toggleMapExpanded()" [class.active]="mapExpanded()"
          [attr.aria-label]="mapExpanded() ? 'Exit expanded map view' : 'Expand map'"
          [attr.aria-pressed]="mapExpanded()">
          <i class="fe" [class.fe-maximize-2]="!mapExpanded()" [class.fe-minimize-2]="mapExpanded()"
            aria-hidden="true"></i>
          <span>{{ mapExpanded() ? 'Exit Expand' : 'Expand Map' }}</span>
        </button>
        <button type="button" class="map-action-btn" (click)="toggleTacticalMode()" [class.active]="tacticalMode()"
          [attr.aria-label]="tacticalMode() ? 'Exit tactical mode' : 'Enter tactical mode'"
          [attr.aria-pressed]="tacticalMode()">
          <i class="fe fe-crosshair" aria-hidden="true"></i>
          <span>Tactical</span>
        </button>
      </div>
      @if (!tacticalMode()) {
      <div id="war-room-filters-panel" class="war-room-filters card custom-card" [class.open]="filtersPanelVisible()">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h6 class="main-content-label mb-0">Open Filters</h6>
          <div class="d-flex align-items-center gap-2">
            @if (activeFilterCount() > 0) {
            <button type="button" class="btn btn-link btn-sm p-0 text-danger" (click)="resetFilters()">Clear
              All</button>
            }
            <button type="button" class="btn-close" (click)="toggleFiltersPanel()" aria-label="Close filters"></button>
          </div>
        </div>
        <div class="card-body">
          <div class="filters-section">
            <button type="button" class="filter-section-header" (click)="toggleFilterSection('companies')"
              [attr.aria-expanded]="expandedFilterSection() === 'companies'">
              <span class="form-label">Companies</span>
              <span class="filter-summary">{{ filterDraft().parentCompanyIds.length ?
                filterDraft().parentCompanyIds.length + ' selected' : 'All' }}</span>
              <i class="fe fe-chevron-down filter-chevron"
                [class.expanded]="expandedFilterSection() === 'companies'"></i>
            </button>
            @if (expandedFilterSection() === 'companies') {
            <div class="filters-options">
              @for (option of parentCompanyOptions(); track option.id) {
              <div class="form-check">
                <input type="checkbox" class="form-check-input"
                  [checked]="filterDraft().parentCompanyIds.includes(option.id)"
                  (change)="toggleParentCompany(option.id)" [id]="'parent-filter-' + option.id" />
                <label class="form-check-label w-100 d-flex justify-content-between align-items-center"
                  [for]="'parent-filter-' + option.id">
                  <span>{{ option.name }}</span>
                  <span class="badge bg-primary-transparent">{{ option.count }}</span>
                </label>
              </div>
              }
            </div>
            }
          </div>
          <div class="filters-section">
            <button type="button" class="filter-section-header" (click)="toggleFilterSection('client')"
              [attr.aria-expanded]="expandedFilterSection() === 'client'">
              <span class="form-label">Client</span>
              <span class="filter-summary">{{ filterDraft().clientIds.length ? filterDraft().clientIds.length + '
                selected' : 'All Clients' }}</span>
              <i class="fe fe-chevron-down filter-chevron" [class.expanded]="expandedFilterSection() === 'client'"></i>
            </button>
            @if (expandedFilterSection() === 'client') {
            <div class="filters-options">
              @for (opt of clientOptionsSignal(); track opt.id) {
              <div class="form-check">
                <input type="checkbox" class="form-check-input" [checked]="filterDraft().clientIds.includes(opt.id)"
                  (change)="toggleClient(opt.id)" [id]="'client-filter-' + opt.id" />
                <label class="form-check-label w-100 d-flex justify-content-between align-items-center"
                  [for]="'client-filter-' + opt.id">
                  <span>{{ opt.name }}</span>
                  <span class="badge bg-primary-transparent">{{ opt.count }}</span>
                </label>
              </div>
              }
            </div>
            }
          </div>
          <div class="filters-section">
            <button type="button" class="filter-section-header" (click)="toggleFilterSection('manufacturer')"
              [attr.aria-expanded]="expandedFilterSection() === 'manufacturer'">
              <span class="form-label">Manufacturer</span>
              <span class="filter-summary">{{ filterDraft().manufacturerIds.length ?
                filterDraft().manufacturerIds.length + ' selected' : 'All Manufacturers' }}</span>
              <i class="fe fe-chevron-down filter-chevron"
                [class.expanded]="expandedFilterSection() === 'manufacturer'"></i>
            </button>
            @if (expandedFilterSection() === 'manufacturer') {
            <div class="filters-options">
              @for (opt of manufacturerOptionsSignal(); track opt.id) {
              <div class="form-check">
                <input type="checkbox" class="form-check-input"
                  [checked]="filterDraft().manufacturerIds.includes(opt.id)" (change)="toggleManufacturer(opt.id)"
                  [id]="'manufacturer-filter-' + opt.id" />
                <label class="form-check-label w-100 d-flex justify-content-between align-items-center"
                  [for]="'manufacturer-filter-' + opt.id">
                  <span>{{ opt.name }}</span>
                  <span class="badge bg-primary-transparent">{{ opt.count }}</span>
                </label>
              </div>
              }
            </div>
            }
          </div>
          <div class="filters-section">
            <button type="button" class="filter-section-header" (click)="toggleFilterSection('projectType')"
              [attr.aria-expanded]="expandedFilterSection() === 'projectType'">
              <span class="form-label">Project Type</span>
              <span class="filter-summary">{{ filterDraft().projectTypeIds.length ? filterDraft().projectTypeIds.length
                + ' selected' : 'All project types' }}</span>
              <i class="fe fe-chevron-down filter-chevron"
                [class.expanded]="expandedFilterSection() === 'projectType'"></i>
            </button>
            @if (expandedFilterSection() === 'projectType') {
            <div class="filters-options">
              @for (opt of projectTypeOptionsSignal(); track opt.id) {
              <div class="form-check">
                <input type="checkbox" class="form-check-input"
                  [checked]="filterDraft().projectTypeIds.includes(opt.id)" (change)="toggleProjectType(opt.id)"
                  [id]="'project-type-filter-' + opt.id" />
                <label class="form-check-label w-100 d-flex justify-content-between align-items-center"
                  [for]="'project-type-filter-' + opt.id">
                  <span>{{ opt.name }}</span>
                  <span class="badge bg-primary-transparent">{{ opt.count }}</span>
                </label>
              </div>
              }
            </div>
            }
          </div>
          <div class="filters-section">
            <label class="form-label" id="status-filter-label">Status</label>
            <div class="filters-pill-group" role="radiogroup" aria-labelledby="status-filter-label">
              <button type="button" class="btn btn-sm" [class.btn-primary]="filterDraft().status === 'all'"
                [class.btn-outline-light]="filterDraft().status !== 'all'" (click)="setStatusFilter('all')"
                [attr.aria-pressed]="filterDraft().status === 'all'">
                All
                <span class="badge bg-white text-primary ms-2">{{ statusCounts().total }}</span>
              </button>
              <button type="button" class="btn btn-sm" [class.btn-success]="filterDraft().status === 'active'"
                [class.btn-outline-light]="filterDraft().status !== 'active'" (click)="setStatusFilter('active')"
                [attr.aria-pressed]="filterDraft().status === 'active'">
                Active
                <span class="badge bg-success-transparent ms-2">{{ statusCounts().active }}</span>
              </button>
              <button type="button" class="btn btn-sm" [class.btn-danger]="filterDraft().status === 'inactive'"
                [class.btn-outline-light]="filterDraft().status !== 'inactive'" (click)="setStatusFilter('inactive')"
                [attr.aria-pressed]="filterDraft().status === 'inactive'">
                Inactive
                <span class="badge bg-secondary-transparent ms-2">{{ statusCounts().inactive }}</span>
              </button>
            </div>
          </div>
          <div class="filters-section">
            <label class="form-label">Regions</label>
            <div class="filters-options">
              @for (region of availableRegions(); track region) {
              <div class="form-check">
                <input type="checkbox" class="form-check-input" [checked]="filterDraft().regions.includes(region)"
                  (change)="toggleRegion(region)" [id]="'region-filter-' + region" />
                <label class="form-check-label" [for]="'region-filter-' + region">{{ region }}</label>
              </div>
              }
            </div>
          </div>
          <div class="filters-actions d-flex gap-2">
            <button type="button" class="btn btn-primary flex-fill" (click)="applyFilters()">Apply Filters</button>
            <button type="button" class="btn btn-outline-primary flex-fill" (click)="resetFilters()">Reset All</button>
          </div>
        </div>
      </div>
      }

      <!-- Tactical mode: top-right Exit button (prominent, easy to find) -->
      @if (tacticalMode()) {
      <div class="war-room-exit-tactical-top" role="group" aria-label="Exit tactical mode">
        <button type="button" class="btn btn-sm war-room-exit-tactical-btn" (click)="toggleTacticalMode()"
          aria-label="Exit tactical mode" title="Exit tactical mode (Esc)">
          <i class="fe fe-crosshair me-2" aria-hidden="true"></i>
          <span>Exit Tactical</span>
        </button>
      </div>
      }
      <!-- Bottom-center view toggle pill (tactical mode only) -->
      @if (tacticalMode()) {
      <div class="war-room-view-toggle-bottom" role="toolbar" aria-label="Map view mode">
        <div class="btn-group btn-group-sm" role="radiogroup" aria-label="Map view mode selection">
          <button type="button" class="btn map-view-btn" [class.btn-primary]="mapViewMode() === 'project'"
            [class.btn-outline-primary]="mapViewMode() !== 'project'" (click)="setMapViewMode('project')"
            role="radio" [attr.aria-checked]="mapViewMode() === 'project'" aria-label="Project view">Project</button>
          <button type="button" class="btn map-view-btn" [class.btn-primary]="mapViewMode() === 'client'"
            [class.btn-outline-primary]="mapViewMode() !== 'client'" (click)="setMapViewMode('client')"
            role="radio" [attr.aria-checked]="mapViewMode() === 'client'" aria-label="Client view">Client</button>
          <button type="button" class="btn map-view-btn" [class.btn-primary]="mapViewMode() === 'factory'"
            [class.btn-outline-primary]="mapViewMode() !== 'factory'" (click)="setMapViewMode('factory')" role="radio"
            [attr.aria-checked]="mapViewMode() === 'factory'" aria-label="Factory view">Factory</button>
        </div>
        <button type="button" class="btn btn-sm map-view-exit-tactical ms-2" (click)="toggleTacticalMode()"
          aria-label="Exit tactical mode" title="Exit tactical mode (Esc)">
          <span>Exit</span>
          <i class="fe fe-x ms-1" aria-hidden="true"></i>
        </button>
      </div>
      }

      @if (!tacticalMode() && projectHudVisible()) {
      <div class="war-room-project-hud-wrapper">
        <app-war-room-project-hud [clientIds]="filterApplied().clientIds"
          [manufacturerIds]="filterApplied().manufacturerIds" [projectTypeIds]="filterApplied().projectTypeIds"
          [selectedProjectId]="selectedProjectId()" (projectSelected)="onProjectHudSelected($event)"
          (closeRequested)="projectHudVisible.set(false)" />
      </div>
      }
      @if (selectedProjectId() || selectedEntity()) {
      <div class="war-room-context-panel-wrapper">
        <app-war-room-context-panel [selectedEntity]="selectedEntity()" [selectedProjectId]="selectedProjectId()" />
      </div>
      }

      @if (!tacticalMode()) {
      <app-war-room-command-menu (actionTriggered)="onCommandAction($event)" />
      }

      <app-war-room-map class="war-room-map-fill" [nodes]="filteredNodes()" [selectedEntity]="selectedEntity()"
        [transitRoutes]="filteredTransitRoutes()" [projectRoutes]="projectRoutesForMap()"
        [filterStatus]="filterApplied().status" (nodeSelected)="onNodeSelected($event)"
        (routeSelected)="onRouteSelected($event)" (zoomStable)="onMapZoomStable($event)"
        (addProjectRequested)="onAddCompanyRequested()"></app-war-room-map>

      @if (filteredNodes().length === 0) {
      <div
        class="empty-state-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center"
        style="background: rgba(255,255,255,0.7); backdrop-filter: blur(2px); z-index: 10;">
        <div class="empty-state-content text-center p-4 card custom-card shadow-lg border-0" style="max-width: 400px;">
          <div class="mb-3">
            <div class="avatar avatar-xxl bg-light rounded-circle text-muted">
              <i class="fe fe-filter fs-40"></i>
            </div>
          </div>
          @if (mapViewMode() === 'client') {
          <h5 class="fw-bold mb-2">No clients match current filters</h5>
          } @else {
          <h5 class="fw-bold mb-2">No companies match current filters</h5>
          }
          <p class="text-muted mb-4 fs-13">Try adjusting your region or status filters, or clear all filters to see the
            full map.</p>
          <button class="btn btn-primary w-100" (click)="clearAllFilters()">
            <i class="fe fe-x me-2"></i> Clear All Filters
          </button>
        </div>
      </div>
      }
      @if (addCompanyModalVisible()) {
      <app-add-company-modal #addCompanyModalRef [isVisible]="true" [useMapPositioning]="true"
        [clients]="clientsSignal()"
        [preselectedFactoryId]="addCompanyModalPreselectedFactoryId()"
        (projectAdded)="onProjectAdded($event)" (close)="onAddCompanyModalClose()" />
      }
    </div>

    <!-- Sidebar -->
    @if (!tacticalMode()) {
    <aside id="war-room-overlay-panel" class="war-room-sidebar" [class.open]="panelVisible()"
      [attr.aria-hidden]="!panelVisible()">
      <div class="sidebar-tabs" role="tablist" aria-label="War room panels">
        <button type="button" class="sidebar-tab-btn" role="tab" id="war-room-tab-log"
          [class.active]="activePanel() === 'log'" [attr.aria-selected]="activePanel() === 'log'"
          [attr.aria-controls]="'war-room-panel-log'" (click)="showPanel('log')">
          Activity Log
        </button>
        <button type="button" class="sidebar-tab-btn" role="tab" id="war-room-tab-hub"
          [class.active]="activePanel() === 'hub'" [attr.aria-selected]="activePanel() === 'hub'"
          [attr.aria-controls]="'war-room-panel-hub'" (click)="showPanel('hub')">
          Hub Status
        </button>
        <button type="button" class="sidebar-close-btn" (click)="togglePanels()" aria-label="Close panels">
          <i class="fe fe-x" aria-hidden="true"></i>
        </button>
      </div>

      @if (activePanel() === 'log') {
      <div class="sidebar-view-level" role="group" aria-label="Activity log view">
        <button type="button" class="sidebar-level-btn" [class.active]="logPanelMode() === 'client'"
          (click)="setLogPanelMode('client')" role="radio" [attr.aria-checked]="logPanelMode() === 'client'"
          aria-label="View clients with projects">
          Client
        </button>
        <button type="button" class="sidebar-level-btn" [class.active]="logPanelMode() === 'manufacturer'"
          (click)="setLogPanelMode('manufacturer')" role="radio" [attr.aria-checked]="logPanelMode() === 'manufacturer'"
          aria-label="View manufacturer hierarchy">
          Manufacturer
        </button>
      </div>
      }

      <div class="sidebar-panel-body">
        <section id="war-room-panel-log" role="tabpanel" [attr.aria-labelledby]="'war-room-tab-log'"
          [attr.hidden]="activePanel() !== 'log' ? '' : null">
          <div class="sidebar-edit-actions d-flex flex-column gap-2 mb-3">
            @if (!activityLogEditMode()) {
            <button type="button" class="sidebar-edit-toggle" (click)="activityLogEditMode.set(true)"
              [attr.aria-label]="'Switch to edit mode'">
              EDIT MODE
            </button>
            } @else {
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-success btn-sm flex-fill" (click)="onSaveChanges()"
                [attr.aria-label]="'Save all changes'">
                SAVE CHANGES
              </button>
              <button type="button" class="btn btn-light btn-sm flex-fill" (click)="onCancelEdit()"
                [attr.aria-label]="'Cancel editing'">
                CANCEL
              </button>
            </div>
            }
          </div>

          @if (logPanelMode() === 'manufacturer') {
          <app-war-room-activity-log [parentGroups]="filteredParentGroups()" [activityLogs]="filteredActivityLogs()"
            [projectStatusByFactoryId]="projectStatusByFactoryId()" [selectedEntity]="selectedEntity()"
            [editMode]="activityLogEditMode()" [mapViewMode]="mapViewMode()" [isBusy]="activityLogBusy()"
            (selectionChange)="onEntitySelected($event)"
            (editModeChange)="activityLogEditMode.set($event)" (factoryDetailsUpdated)="onFactoryDetailsUpdated($event)"
            (subsidiaryDetailsUpdated)="onSubsidiaryDetailsUpdated($event)"
            (batchUpdateRequested)="onBatchUpdateRequested($event)" (subsidiaryDeleted)="onSubsidiaryDeleted($event)"
            (factoryDeleted)="onFactoryDeleted($event)"
            (addProjectForFactory)="onAddProjectForFactory($event)"></app-war-room-activity-log>
          } @else {
          <app-war-room-clients-panel [clientsWithProjects]="clientsWithProjects()" [editMode]="activityLogEditMode()"
            [selectedEntity]="selectedEntity()" [projectsRefreshTrigger]="projectRoutesRefreshTrigger()"
            (clientSelected)="onClientSelected($event)"
            (projectSelected)="onProjectHudSelected($event)"
            (saveComplete)="onClientPanelSaveComplete()"></app-war-room-clients-panel>
          }
        </section>

        <section id="war-room-panel-hub" role="tabpanel" [attr.aria-labelledby]="'war-room-tab-hub'"
          [attr.hidden]="activePanel() !== 'hub' ? '' : null">
          <app-war-room-hub-status [selectedSubsidiary]="selectedSubsidiary()"
            (addCompanyRequested)="onAddCompanyRequested()"></app-war-room-hub-status>
        </section>
      </div>
    </aside>
    }
  </main>
</div>
