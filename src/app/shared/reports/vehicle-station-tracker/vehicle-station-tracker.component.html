<div class="container-fluid">
  <!-- Page Header -->
  <div class="page-header" style="margin-top: 2rem;">
    <div>
      <h2 class="main-content-title tx-24 mg-b-5">Vehicle Station Tracker Report</h2>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a [routerLink]="['/admin/dashboard']">Home</a></li>
        <li class="breadcrumb-item"><a [routerLink]="['/admin/reports']">Reports</a></li>
        <li class="breadcrumb-item"><a [routerLink]="['/admin/reports/vehicle-reports']">Vehicle Reports</a></li>
        <li class="breadcrumb-item active" aria-current="page">Vehicle Station Tracker</li>
      </ol>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="row">
    <div class="col-12">
      <div class="card custom-card">
        <div class="card-body">
          <div class="row g-3">
            <!-- Project Filter -->
            <div class="col-md-4">
              <label class="form-label">Project</label>
              <select 
                class="form-select" 
                [(ngModel)]="selectedProject"
                [disabled]="isLoadingFilters">
                <option value="">Select Project</option>
                <option *ngFor="let project of projects" [value]="project.name">{{ project.name }}</option>
              </select>
            </div>

            <!-- Search -->
            <div class="col-md-4">
              <label class="form-label">Search</label>
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="searchTerm"
                (ngModelChange)="filterData()"
                placeholder="Search by Fleet Number, VIN, or Frame Number">
            </div>

            <!-- Actions -->
            <div class="col-md-4 d-flex align-items-end gap-2">
              <button 
                class="btn btn-primary flex-fill"
                (click)="runReport()"
                [disabled]="isLoading || !selectedProject">
                <i class="ti-file me-2"></i>
                <span *ngIf="!isLoading">Run Report</span>
                <span *ngIf="isLoading">Loading...</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div class="row" *ngIf="errorMessage">
    <div class="col-12">
      <div class="alert alert-danger" role="alert">
        <i class="ti-alert me-2"></i>{{ errorMessage }}
      </div>
    </div>
  </div>

  <!-- Report Results -->
  <div class="row" *ngIf="reportGenerated && !isLoading">
    <div class="col-12">
      <div class="card custom-card">
        <div class="card-header border-bottom">
          <div class="d-flex justify-content-between align-items-center w-100">
            <div>
              <h6 class="main-content-label mb-1">Station Tracker Results</h6>
              <small class="text-muted">{{ filteredData.length }} vehicles found</small>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-secondary" (click)="printReport()">
                <i class="ti-printer me-1"></i> Print
              </button>
              <button class="btn btn-sm btn-success" (click)="downloadReport()">
                <i class="ti-download me-1"></i> Download
              </button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <!-- Station Legend -->
          <div class="station-legend-container" [class.sticky]="!isLegendCollapsed">
            <div class="station-legend" [class.collapsed]="isLegendCollapsed">
              <div class="legend-header mb-3">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="mb-0"><i class="ti-info-alt me-2"></i>Station Reference Guide</h6>
                  <button class="btn btn-sm btn-outline-primary legend-toggle" (click)="toggleLegend()" type="button">
                    <i [class]="isLegendCollapsed ? 'ti-angle-down' : 'ti-angle-up'"></i>
                    {{ isLegendCollapsed ? 'Show' : 'Hide' }}
                  </button>
                </div>
              </div>
              <div class="legend-grid" *ngIf="!isLegendCollapsed">
              <div class="legend-item" *ngFor="let station of stationColumns">
                <div class="legend-number">{{ station.key.replace('station', '') }}</div>
                <div class="legend-description">{{ station.label.split(' - ')[1] }}</div>
              </div>
            </div>
          </div>
          </div>
          <div class="table-responsive">
            <table class="table table-bordered station-tracker-table mb-0">
              <thead class="table-light">
                <tr>
                  <th class="text-center" style="width: 50px;">#</th>
                  <th style="min-width: 140px;">Vehicle</th>
                  <th style="min-width: 180px;">VIN</th>
                  <th style="min-width: 100px;">Frame</th>
                  <th *ngFor="let station of stationColumns" class="text-center station-col" [title]="station.label">
                    <span (click)="sortByColumn(station.key)" style="cursor:pointer;">
                      {{ station.key.replace('station', '') }}
                      <span *ngIf="sortColumn === station.key">
                        <i [ngClass]="sortDirection === 'asc' ? 'ti-arrow-up' : 'ti-arrow-down'"></i>
                      </span>
                    </span>
                  </th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngFor="let item of filteredData; let i = index">
                  <!-- Main Row -->
                  <tr class="main-row">
                    <td class="text-center">
                      {{ (currentPage - 1) * pageSize + i + 1 }}
                    </td>
                    <td>
                      <strong class="text-primary">{{ item.fleetNumber }}</strong>
                    </td>
                    <td class="text-muted small">{{ item.vin }}</td>
                    <td>{{ item.frameNumber }}</td>
                    <td *ngFor="let station of stationColumns" class="text-center station-cell" 
                        [class.completed]="isStationCompleted(item, station.key)">
                      <div *ngIf="isStationCompleted(item, station.key)" class="station-completed">
                        <i class="ti-check text-success"></i>
                        <div class="station-date">{{ getStationValue(item, station.key) }}</div>
                      </div>
                      <div *ngIf="!isStationCompleted(item, station.key)" class="station-pending">
                        <i class="ti-minus text-muted"></i>
                      </div>
                    </td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
          </div>

          <!-- Pagination Controls -->
          <div class="card-footer border-top" *ngIf="reportGenerated && totalCount > 10">
            <div class="d-flex justify-content-between align-items-center gap-3 flex-wrap">
              <div class="text-muted small">
                Showing <strong>{{ (currentPage - 1) * pageSize + 1 }}</strong> to <strong>{{ Math.min(currentPage * pageSize, totalCount) }}</strong> of <strong>{{ totalCount }}</strong> vehicles
              </div>
              
              <nav aria-label="Pagination" *ngIf="getTotalPages() > 1">
                <ul class="pagination mb-0">
                  <li class="page-item" [class.disabled]="currentPage === 1">
                    <button class="page-link" (click)="previousPage()" [disabled]="currentPage === 1" type="button">
                      <i class="ti-angle-left"></i> Previous
                    </button>
                  </li>
                  
                  <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage" [class.disabled]="page === -1">
                    <button *ngIf="page !== -1" class="page-link" (click)="goToPage(page)" [class.active]="page === currentPage" type="button">
                      {{ page }}
                    </button>
                    <span class="page-link" *ngIf="page === -1">...</span>
                  </li>
                  
                  <li class="page-item" [class.disabled]="currentPage === getTotalPages()">
                    <button class="page-link" (click)="nextPage()" [disabled]="currentPage === getTotalPages()" type="button">
                      Next <i class="ti-angle-right"></i>
                    </button>
                  </li>
                </ul>
              </nav>
            </div>
          </div>

          <!-- No Data Message -->
          <div *ngIf="filteredData.length === 0" class="text-center py-5">
            <i class="ti-na tx-60 text-muted"></i>
            <p class="text-muted mt-3">No tracker data available for the selected filters</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="row" *ngIf="isLoading">
    <div class="col-12">
      <div class="card custom-card">
        <div class="card-body text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="text-muted mt-3">Loading station tracker data...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="row" *ngIf="!reportGenerated && !isLoading">
    <div class="col-12">
      <div class="card custom-card">
        <div class="card-body text-center py-5">
          <i class="ti-clipboard tx-60 text-muted"></i>
          <p class="text-muted mt-3 mb-0">Select a project and run the report to view station tracker data</p>
        </div>
      </div>
    </div>
